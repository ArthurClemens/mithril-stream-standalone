{"version":3,"file":"mithril-stream-standalone.module.js","sources":["../src/stream.js"],"sourcesContent":["/*\nMithril license: https://github.com/MithrilJS/mithril.js/blob/next/LICENSE\n*/\n\nfunction merge(streams) {\n  return combine(function () {\n    return streams.map(function (s) {\n      return s();\n    });\n  }, streams);\n}\n\nfunction scan(fn, acc, origin) {\n  var stream = origin.map(function (v) {\n    var next = fn(acc, v);\n    if (next !== Stream.SKIP) acc = next;\n    return next;\n  });\n  stream(acc);\n  return stream;\n}\n\nfunction scanMerge(tuples, seed) {\n  var streams = tuples.map(function (tuple) {\n    return tuple[0];\n  });\n\n  var stream = combine(function () {\n    var changed = arguments[arguments.length - 1];\n    streams.forEach(function (stream, i) {\n      if (changed.indexOf(stream) > -1) seed = tuples[i][1](seed, stream());\n    });\n\n    return seed;\n  }, streams);\n\n  stream(seed);\n\n  return stream;\n}\n\nfunction lift() {\n  var fn = arguments[0];\n  var streams = Array.prototype.slice.call(arguments, 1);\n  return merge(streams).map(function (streams) {\n    return fn.apply(undefined, streams);\n  });\n}\n\nfunction open(s) {\n  return (\n    s._state === \"pending\" || s._state === \"active\" || s._state === \"changing\"\n  );\n}\n\nvar Stream = function (value) {\n  var dependentStreams = [];\n  var dependentFns = [];\n\n  function stream(v) {\n    if (arguments.length && v !== Stream.SKIP) {\n      value = v;\n      if (open(stream)) {\n        stream._changing();\n        stream._state = \"active\";\n        // Cloning the list to ensure it's still iterated in intended\n        // order\n        dependentStreams.slice().forEach(function (s, i) {\n          if (open(s)) s(this[i](value));\n        }, dependentFns.slice());\n      }\n    }\n\n    return value;\n  }\n\n  stream.constructor = Stream;\n  stream._state =\n    arguments.length && value !== Stream.SKIP ? \"active\" : \"pending\";\n  stream._parents = [];\n\n  stream._changing = function () {\n    if (open(stream)) stream._state = \"changing\";\n    dependentStreams.forEach(function (s) {\n      s._changing();\n    });\n  };\n\n  stream._map = function (fn, ignoreInitial) {\n    var target = ignoreInitial ? Stream() : Stream(fn(value));\n    target._parents.push(stream);\n    dependentStreams.push(target);\n    dependentFns.push(fn);\n    return target;\n  };\n\n  stream.map = function (fn) {\n    return stream._map(fn, stream._state !== \"active\");\n  };\n\n  var end;\n  function createEnd() {\n    end = Stream();\n    end.map(function (value) {\n      if (value === true) {\n        stream._parents.forEach(function (p) {\n          p._unregisterChild(stream);\n        });\n        stream._state = \"ended\";\n        stream._parents.length =\n          dependentStreams.length =\n          dependentFns.length =\n            0;\n      }\n      return value;\n    });\n    return end;\n  }\n\n  stream.toJSON = function () {\n    return value != null && typeof value.toJSON === \"function\"\n      ? value.toJSON()\n      : value;\n  };\n\n  stream[\"fantasy-land/map\"] = stream.map;\n  stream[\"fantasy-land/ap\"] = function (x) {\n    return combine(\n      function (s1, s2) {\n        return s1()(s2());\n      },\n      [x, stream]\n    );\n  };\n\n  stream._unregisterChild = function (child) {\n    var childIndex = dependentStreams.indexOf(child);\n    if (childIndex !== -1) {\n      dependentStreams.splice(childIndex, 1);\n      dependentFns.splice(childIndex, 1);\n    }\n  };\n\n  Object.defineProperty(stream, \"end\", {\n    get: function () {\n      return end || createEnd();\n    },\n  });\n\n  return stream;\n};\n\nfunction combine(fn, streams) {\n  var ready = streams.every(function (s) {\n    if (s.constructor !== Stream)\n      throw new Error(\n        \"Ensure that each item passed to stream.combine/stream.merge/lift is a stream.\"\n      );\n    return s._state === \"active\";\n  });\n  var stream = ready\n    ? Stream(fn.apply(null, streams.concat([streams])))\n    : Stream();\n\n  var changed = [];\n\n  var mappers = streams.map(function (s) {\n    return s._map(function (value) {\n      changed.push(s);\n      if (\n        ready ||\n        streams.every(function (s) {\n          return s._state !== \"pending\";\n        })\n      ) {\n        ready = true;\n        stream(fn.apply(null, streams.concat([changed])));\n        changed = [];\n      }\n      return value;\n    }, true);\n  });\n\n  var endStream = stream.end.map(function (value) {\n    if (value === true) {\n      mappers.forEach(function (mapper) {\n        mapper.end(true);\n      });\n      endStream.end(true);\n    }\n    return undefined;\n  });\n\n  return stream;\n}\n\nStream.SKIP = {};\nStream.lift = lift;\nStream.scan = scan;\nStream.merge = merge;\nStream.combine = combine;\nStream.scanMerge = scanMerge;\nStream[\"fantasy-land/of\"] = Stream;\n\nvar warnedHalt = false;\nObject.defineProperty(Stream, \"HALT\", {\n  get: function () {\n    warnedHalt ||\n      console.log(\"HALT is deprecated and has been renamed to SKIP\");\n    warnedHalt = true;\n    return Stream.SKIP;\n  },\n});\n\nexport { Stream as default };\n"],"names":["merge","streams","combine","s","scan","fn","acc","origin","stream","v","next","Stream","scanMerge","tuples","seed","tuple","changed","i","lift","open","value","dependentStreams","dependentFns","ignoreInitial","target","end","createEnd","p","x","s1","s2","child","childIndex","ready","mappers","endStream","mapper","warnedHalt"],"mappings":"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"}