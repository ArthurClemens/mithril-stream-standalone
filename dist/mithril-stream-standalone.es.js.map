{"version":3,"file":"mithril-stream-standalone.es.js","sources":["../src/stream.js"],"sourcesContent":["/*\nMithril license: https://github.com/MithrilJS/mithril.js/blob/next/LICENSE\n*/\n\n/* eslint-disable */\n(function () {\n  \"use strict\";\n  /* eslint-enable */\n  Stream.SKIP = {};\n  Stream.lift = lift;\n  Stream.scan = scan;\n  Stream.merge = merge;\n  Stream.combine = combine;\n  Stream.scanMerge = scanMerge;\n  Stream[\"fantasy-land/of\"] = Stream;\n\n  var warnedHalt = false;\n  Object.defineProperty(Stream, \"HALT\", {\n    get: function () {\n      warnedHalt ||\n        console.log(\"HALT is deprecated and has been renamed to SKIP\");\n      warnedHalt = true;\n      return Stream.SKIP;\n    },\n  });\n\n  function Stream(value) {\n    var dependentStreams = [];\n    var dependentFns = [];\n\n    function stream(v) {\n      if (arguments.length && v !== Stream.SKIP) {\n        value = v;\n        if (open(stream)) {\n          stream._changing();\n          stream._state = \"active\";\n          // Cloning the list to ensure it's still iterated in intended\n          // order\n          dependentStreams.slice().forEach(function (s, i) {\n            if (open(s)) s(this[i](value));\n          }, dependentFns.slice());\n        }\n      }\n\n      return value;\n    }\n\n    stream.constructor = Stream;\n    stream._state =\n      arguments.length && value !== Stream.SKIP ? \"active\" : \"pending\";\n    stream._parents = [];\n\n    stream._changing = function () {\n      if (open(stream)) stream._state = \"changing\";\n      dependentStreams.forEach(function (s) {\n        s._changing();\n      });\n    };\n\n    stream._map = function (fn, ignoreInitial) {\n      var target = ignoreInitial ? Stream() : Stream(fn(value));\n      target._parents.push(stream);\n      dependentStreams.push(target);\n      dependentFns.push(fn);\n      return target;\n    };\n\n    stream.map = function (fn) {\n      return stream._map(fn, stream._state !== \"active\");\n    };\n\n    var end;\n    function createEnd() {\n      end = Stream();\n      end.map(function (value) {\n        if (value === true) {\n          stream._parents.forEach(function (p) {\n            p._unregisterChild(stream);\n          });\n          stream._state = \"ended\";\n          stream._parents.length =\n            dependentStreams.length =\n            dependentFns.length =\n              0;\n        }\n        return value;\n      });\n      return end;\n    }\n\n    stream.toJSON = function () {\n      return value != null && typeof value.toJSON === \"function\"\n        ? value.toJSON()\n        : value;\n    };\n\n    stream[\"fantasy-land/map\"] = stream.map;\n    stream[\"fantasy-land/ap\"] = function (x) {\n      return combine(\n        function (s1, s2) {\n          return s1()(s2());\n        },\n        [x, stream]\n      );\n    };\n\n    stream._unregisterChild = function (child) {\n      var childIndex = dependentStreams.indexOf(child);\n      if (childIndex !== -1) {\n        dependentStreams.splice(childIndex, 1);\n        dependentFns.splice(childIndex, 1);\n      }\n    };\n\n    Object.defineProperty(stream, \"end\", {\n      get: function () {\n        return end || createEnd();\n      },\n    });\n\n    return stream;\n  }\n\n  function combine(fn, streams) {\n    var ready = streams.every(function (s) {\n      if (s.constructor !== Stream)\n        throw new Error(\n          \"Ensure that each item passed to stream.combine/stream.merge/lift is a stream.\"\n        );\n      return s._state === \"active\";\n    });\n    var stream = ready\n      ? Stream(fn.apply(null, streams.concat([streams])))\n      : Stream();\n\n    var changed = [];\n\n    var mappers = streams.map(function (s) {\n      return s._map(function (value) {\n        changed.push(s);\n        if (\n          ready ||\n          streams.every(function (s) {\n            return s._state !== \"pending\";\n          })\n        ) {\n          ready = true;\n          stream(fn.apply(null, streams.concat([changed])));\n          changed = [];\n        }\n        return value;\n      }, true);\n    });\n\n    var endStream = stream.end.map(function (value) {\n      if (value === true) {\n        mappers.forEach(function (mapper) {\n          mapper.end(true);\n        });\n        endStream.end(true);\n      }\n      return undefined;\n    });\n\n    return stream;\n  }\n\n  function merge(streams) {\n    return combine(function () {\n      return streams.map(function (s) {\n        return s();\n      });\n    }, streams);\n  }\n\n  function scan(fn, acc, origin) {\n    var stream = origin.map(function (v) {\n      var next = fn(acc, v);\n      if (next !== Stream.SKIP) acc = next;\n      return next;\n    });\n    stream(acc);\n    return stream;\n  }\n\n  function scanMerge(tuples, seed) {\n    var streams = tuples.map(function (tuple) {\n      return tuple[0];\n    });\n\n    var stream = combine(function () {\n      var changed = arguments[arguments.length - 1];\n      streams.forEach(function (stream, i) {\n        if (changed.indexOf(stream) > -1) seed = tuples[i][1](seed, stream());\n      });\n\n      return seed;\n    }, streams);\n\n    stream(seed);\n\n    return stream;\n  }\n\n  function lift() {\n    var fn = arguments[0];\n    var streams = Array.prototype.slice.call(arguments, 1);\n    return merge(streams).map(function (streams) {\n      return fn.apply(undefined, streams);\n    });\n  }\n\n  function open(s) {\n    return (\n      s._state === \"pending\" || s._state === \"active\" || s._state === \"changing\"\n    );\n  }\n\n  if (typeof module !== \"undefined\") module[\"exports\"] = Stream;\n  else if (typeof window.m === \"function\" && !(\"stream\" in window.m))\n    window.m.stream = Stream;\n  else window.m = { stream: Stream };\n})();\n"],"names":["SKIP","lift","fn","arguments","streams","Array","prototype","slice","call","merge","map","streams2","apply","scan","acc","origin","stream","v","next","Stream","combine","scanMerge","tuples","seed","tuple","changed","length","forEach","stream2","i","indexOf","warnedHalt","value","end","dependentStreams","dependentFns","open","_changing","_state","s","this","value2","_parents","p","_unregisterChild","constructor","_map","ignoreInitial","target","push","toJSON","x","s1","s2","child","childIndex","splice","defineProperty","get","createEnd","ready","every","Error","concat","mappers","endStream","mapper","console","log","module","window","m"],"mappings":"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"}