{"version":3,"file":"mithril-stream-standalone.umd.js","sources":["../src/stream.js"],"sourcesContent":["/*\nMithril license: https://github.com/MithrilJS/mithril.js/blob/next/LICENSE\n*/\n\nfunction merge(streams) {\n  return combine(function () {\n    return streams.map(function (s) {\n      return s();\n    });\n  }, streams);\n}\n\nfunction scan(fn, acc, origin) {\n  var stream = origin.map(function (v) {\n    var next = fn(acc, v);\n    if (next !== Stream.SKIP) acc = next;\n    return next;\n  });\n  stream(acc);\n  return stream;\n}\n\nfunction scanMerge(tuples, seed) {\n  var streams = tuples.map(function (tuple) {\n    return tuple[0];\n  });\n\n  var stream = combine(function () {\n    var changed = arguments[arguments.length - 1];\n    streams.forEach(function (stream, i) {\n      if (changed.indexOf(stream) > -1) seed = tuples[i][1](seed, stream());\n    });\n\n    return seed;\n  }, streams);\n\n  stream(seed);\n\n  return stream;\n}\n\nfunction lift() {\n  var fn = arguments[0];\n  var streams = Array.prototype.slice.call(arguments, 1);\n  return merge(streams).map(function (streams) {\n    return fn.apply(undefined, streams);\n  });\n}\n\nfunction open(s) {\n  return (\n    s._state === \"pending\" || s._state === \"active\" || s._state === \"changing\"\n  );\n}\n\nvar Stream = function (value) {\n  var dependentStreams = [];\n  var dependentFns = [];\n\n  function stream(v) {\n    if (arguments.length && v !== Stream.SKIP) {\n      value = v;\n      if (open(stream)) {\n        stream._changing();\n        stream._state = \"active\";\n        // Cloning the list to ensure it's still iterated in intended\n        // order\n        dependentStreams.slice().forEach(function (s, i) {\n          if (open(s)) s(this[i](value));\n        }, dependentFns.slice());\n      }\n    }\n\n    return value;\n  }\n\n  stream.constructor = Stream;\n  stream._state =\n    arguments.length && value !== Stream.SKIP ? \"active\" : \"pending\";\n  stream._parents = [];\n\n  stream._changing = function () {\n    if (open(stream)) stream._state = \"changing\";\n    dependentStreams.forEach(function (s) {\n      s._changing();\n    });\n  };\n\n  stream._map = function (fn, ignoreInitial) {\n    var target = ignoreInitial ? Stream() : Stream(fn(value));\n    target._parents.push(stream);\n    dependentStreams.push(target);\n    dependentFns.push(fn);\n    return target;\n  };\n\n  stream.map = function (fn) {\n    return stream._map(fn, stream._state !== \"active\");\n  };\n\n  var end;\n  function createEnd() {\n    end = Stream();\n    end.map(function (value) {\n      if (value === true) {\n        stream._parents.forEach(function (p) {\n          p._unregisterChild(stream);\n        });\n        stream._state = \"ended\";\n        stream._parents.length =\n          dependentStreams.length =\n          dependentFns.length =\n            0;\n      }\n      return value;\n    });\n    return end;\n  }\n\n  stream.toJSON = function () {\n    return value != null && typeof value.toJSON === \"function\"\n      ? value.toJSON()\n      : value;\n  };\n\n  stream[\"fantasy-land/map\"] = stream.map;\n  stream[\"fantasy-land/ap\"] = function (x) {\n    return combine(\n      function (s1, s2) {\n        return s1()(s2());\n      },\n      [x, stream]\n    );\n  };\n\n  stream._unregisterChild = function (child) {\n    var childIndex = dependentStreams.indexOf(child);\n    if (childIndex !== -1) {\n      dependentStreams.splice(childIndex, 1);\n      dependentFns.splice(childIndex, 1);\n    }\n  };\n\n  Object.defineProperty(stream, \"end\", {\n    get: function () {\n      return end || createEnd();\n    },\n  });\n\n  return stream;\n};\n\nfunction combine(fn, streams) {\n  var ready = streams.every(function (s) {\n    if (s.constructor !== Stream)\n      throw new Error(\n        \"Ensure that each item passed to stream.combine/stream.merge/lift is a stream.\"\n      );\n    return s._state === \"active\";\n  });\n  var stream = ready\n    ? Stream(fn.apply(null, streams.concat([streams])))\n    : Stream();\n\n  var changed = [];\n\n  var mappers = streams.map(function (s) {\n    return s._map(function (value) {\n      changed.push(s);\n      if (\n        ready ||\n        streams.every(function (s) {\n          return s._state !== \"pending\";\n        })\n      ) {\n        ready = true;\n        stream(fn.apply(null, streams.concat([changed])));\n        changed = [];\n      }\n      return value;\n    }, true);\n  });\n\n  var endStream = stream.end.map(function (value) {\n    if (value === true) {\n      mappers.forEach(function (mapper) {\n        mapper.end(true);\n      });\n      endStream.end(true);\n    }\n    return undefined;\n  });\n\n  return stream;\n}\n\nStream.SKIP = {};\nStream.lift = lift;\nStream.scan = scan;\nStream.merge = merge;\nStream.combine = combine;\nStream.scanMerge = scanMerge;\nStream[\"fantasy-land/of\"] = Stream;\n\nvar warnedHalt = false;\nObject.defineProperty(Stream, \"HALT\", {\n  get: function () {\n    warnedHalt ||\n      console.log(\"HALT is deprecated and has been renamed to SKIP\");\n    warnedHalt = true;\n    return Stream.SKIP;\n  },\n});\n\nexport { Stream as default };\n"],"names":["merge","streams","combine","s","scan","fn","acc","origin","stream","v","next","Stream","scanMerge","tuples","seed","tuple","changed","lift","open","value","dependentStreams","dependentFns","i","ignoreInitial","target","end","createEnd","p","x","s1","s2","child","childIndex","ready","mappers","endStream","mapper","warnedHalt"],"mappings":"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"}